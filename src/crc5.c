#include <stdint.h>
/* 
CRC-16/CCITT-FALSE
    width=16 poly=0x1021 init=0xffff refin=false refout=false xorout=0x0000 check=0x29b1 name="CRC-16/CCITT-FALSE"

\see стандарт ITU-T Rec. X.25. там описан полином и способ вычисления FCS — контрольной суммы типа CRC16. Отсюда взялось название CRC16_ITU.

XMODEM Alias: ZMODEM, CRC-16/ACORN
    width=16 poly=0x1021 init=0x0000 refin=false refout=false xorout=0x0000 check=0x31c3 name="XMODEM"

CRC-15/CAN Alias: CRC-15
    width=15 poly=0x4599 init=0x0000 refin=false refout=false xorout=0x0000 check=0x059e name="CRC-15"

    Robert Bosch GmbH (September 1991), CAN 2.0 Specification

CRC-8/SMBUS Alias: CRC-8
    width=8 poly=0x07 init=0x00 refin=false refout=false xorout=0x00 check=0xf4 name="CRC-8"

CRC-5/BITMAIN
    width=5 poly=0x05 init=0x1f refin=false refout=false xorout=0x0 check=0x0F name="CRC-5/BITMAIN"
 */
static const uint16_t crc16_table[256]=
{
	0x0000, 0x1021, 0x2042, 0x3063, 0x4084, 0x50A5, 0x60C6, 0x70E7,
	0x8108, 0x9129, 0xA14A, 0xB16B, 0xC18C, 0xD1AD, 0xE1CE, 0xF1EF,
	0x1231, 0x0210, 0x3273, 0x2252, 0x52B5, 0x4294, 0x72F7, 0x62D6,
	0x9339, 0x8318, 0xB37B, 0xA35A, 0xD3BD, 0xC39C, 0xF3FF, 0xE3DE,
	0x2462, 0x3443, 0x0420, 0x1401, 0x64E6, 0x74C7, 0x44A4, 0x5485,
	0xA56A, 0xB54B, 0x8528, 0x9509, 0xE5EE, 0xF5CF, 0xC5AC, 0xD58D,
	0x3653, 0x2672, 0x1611, 0x0630, 0x76D7, 0x66F6, 0x5695, 0x46B4,
	0xB75B, 0xA77A, 0x9719, 0x8738, 0xF7DF, 0xE7FE, 0xD79D, 0xC7BC,
	0x48C4, 0x58E5, 0x6886, 0x78A7, 0x0840, 0x1861, 0x2802, 0x3823,
	0xC9CC, 0xD9ED, 0xE98E, 0xF9AF, 0x8948, 0x9969, 0xA90A, 0xB92B,
	0x5AF5, 0x4AD4, 0x7AB7, 0x6A96, 0x1A71, 0x0A50, 0x3A33, 0x2A12,
	0xDBFD, 0xCBDC, 0xFBBF, 0xEB9E, 0x9B79, 0x8B58, 0xBB3B, 0xAB1A,
	0x6CA6, 0x7C87, 0x4CE4, 0x5CC5, 0x2C22, 0x3C03, 0x0C60, 0x1C41,
	0xEDAE, 0xFD8F, 0xCDEC, 0xDDCD, 0xAD2A, 0xBD0B, 0x8D68, 0x9D49,
	0x7E97, 0x6EB6, 0x5ED5, 0x4EF4, 0x3E13, 0x2E32, 0x1E51, 0x0E70,
	0xFF9F, 0xEFBE, 0xDFDD, 0xCFFC, 0xBF1B, 0xAF3A, 0x9F59, 0x8F78,
	0x9188, 0x81A9, 0xB1CA, 0xA1EB, 0xD10C, 0xC12D, 0xF14E, 0xE16F,
	0x1080, 0x00A1, 0x30C2, 0x20E3, 0x5004, 0x4025, 0x7046, 0x6067,
	0x83B9, 0x9398, 0xA3FB, 0xB3DA, 0xC33D, 0xD31C, 0xE37F, 0xF35E,
	0x02B1, 0x1290, 0x22F3, 0x32D2, 0x4235, 0x5214, 0x6277, 0x7256,
	0xB5EA, 0xA5CB, 0x95A8, 0x8589, 0xF56E, 0xE54F, 0xD52C, 0xC50D,
	0x34E2, 0x24C3, 0x14A0, 0x0481, 0x7466, 0x6447, 0x5424, 0x4405,
	0xA7DB, 0xB7FA, 0x8799, 0x97B8, 0xE75F, 0xF77E, 0xC71D, 0xD73C,
	0x26D3, 0x36F2, 0x0691, 0x16B0, 0x6657, 0x7676, 0x4615, 0x5634,
	0xD94C, 0xC96D, 0xF90E, 0xE92F, 0x99C8, 0x89E9, 0xB98A, 0xA9AB,
	0x5844, 0x4865, 0x7806, 0x6827, 0x18C0, 0x08E1, 0x3882, 0x28A3,
	0xCB7D, 0xDB5C, 0xEB3F, 0xFB1E, 0x8BF9, 0x9BD8, 0xABBB, 0xBB9A,
	0x4A75, 0x5A54, 0x6A37, 0x7A16, 0x0AF1, 0x1AD0, 0x2AB3, 0x3A92,
	0xFD2E, 0xED0F, 0xDD6C, 0xCD4D, 0xBDAA, 0xAD8B, 0x9DE8, 0x8DC9,
	0x7C26, 0x6C07, 0x5C64, 0x4C45, 0x3CA2, 0x2C83, 0x1CE0, 0x0CC1,
	0xEF1F, 0xFF3E, 0xCF5D, 0xDF7C, 0xAF9B, 0xBFBA, 0x8FD9, 0x9FF8,
	0x6E17, 0x7E36, 0x4E55, 0x5E74, 0x2E93, 0x3EB2, 0x0ED1, 0x1EF0
};

static const uint8_t CRC5_Lookup[256]=
{
	0x00, 0x28, 0x50, 0x78,
	0xA0, 0x88, 0xF0, 0xD8,
	0x68, 0x40, 0x38, 0x10,
	0xC8, 0xE0, 0x98, 0xB0,
	0xD0, 0xF8, 0x80, 0xA8,
	0x70, 0x58, 0x20, 0x08,
	0xB8, 0x90, 0xE8, 0xC0,
	0x18, 0x30, 0x48, 0x60,
	0x88, 0xA0, 0xD8, 0xF0,
	0x28, 0x00, 0x78, 0x50,
	0xE0, 0xC8, 0xB0, 0x98,
	0x40, 0x68, 0x10, 0x38,
	0x58, 0x70, 0x08, 0x20,
	0xF8, 0xD0, 0xA8, 0x80,
	0x30, 0x18, 0x60, 0x48,
	0x90, 0xB8, 0xC0, 0xE8,
	0x38, 0x10, 0x68, 0x40,
	0x98, 0xB0, 0xC8, 0xE0,
	0x50, 0x78, 0x00, 0x28,
	0xF0, 0xD8, 0xA0, 0x88,
	0xE8, 0xC0, 0xB8, 0x90,
	0x48, 0x60, 0x18, 0x30,
	0x80, 0xA8, 0xD0, 0xF8,
	0x20, 0x08, 0x70, 0x58,
	0xB0, 0x98, 0xE0, 0xC8,
	0x10, 0x38, 0x40, 0x68,
	0xD8, 0xF0, 0x88, 0xA0,
	0x78, 0x50, 0x28, 0x00,
	0x60, 0x48, 0x30, 0x18,
	0xC0, 0xE8, 0x90, 0xB8,
	0x08, 0x20, 0x58, 0x70,
	0xA8, 0x80, 0xF8, 0xD0,
	0x70, 0x58, 0x20, 0x08,
	0xD0, 0xF8, 0x80, 0xA8,
	0x18, 0x30, 0x48, 0x60,
	0xB8, 0x90, 0xE8, 0xC0,
	0xA0, 0x88, 0xF0, 0xD8,
	0x00, 0x28, 0x50, 0x78,
	0xC8, 0xE0, 0x98, 0xB0,
	0x68, 0x40, 0x38, 0x10,
	0xF8, 0xD0, 0xA8, 0x80,
	0x58, 0x70, 0x08, 0x20,
	0x90, 0xB8, 0xC0, 0xE8,
	0x30, 0x18, 0x60, 0x48,
	0x28, 0x00, 0x78, 0x50,
	0x88, 0xA0, 0xD8, 0xF0,
	0x40, 0x68, 0x10, 0x38,
	0xE0, 0xC8, 0xB0, 0x98,
	0x48, 0x60, 0x18, 0x30,
	0xE8, 0xC0, 0xB8, 0x90,
	0x20, 0x08, 0x70, 0x58,
	0x80, 0xA8, 0xD0, 0xF8,
	0x98, 0xB0, 0xC8, 0xE0,
	0x38, 0x10, 0x68, 0x40,
	0xF0, 0xD8, 0xA0, 0x88,
	0x50, 0x78, 0x00, 0x28,
	0xC0, 0xE8, 0x90, 0xB8,
	0x60, 0x48, 0x30, 0x18,
	0xA8, 0x80, 0xF8, 0xD0,
	0x08, 0x20, 0x58, 0x70,
	0x10, 0x38, 0x40, 0x68,
	0xB0, 0x98, 0xE0, 0xC8,
	0x78, 0x50, 0x28, 0x00,
	0xD8, 0xF0, 0x88, 0xA0,
};
static const uint8_t CRC8_Lookup[] = {
// CRC-8/SMBUS POLY=0x07
0x00, 0x07, 0x0E, 0x09, 0x1C, 0x1B, 0x12, 0x15,
0x38, 0x3F, 0x36, 0x31, 0x24, 0x23, 0x2A, 0x2D,
0x70, 0x77, 0x7E, 0x79, 0x6C, 0x6B, 0x62, 0x65,
0x48, 0x4F, 0x46, 0x41, 0x54, 0x53, 0x5A, 0x5D,
0xE0, 0xE7, 0xEE, 0xE9, 0xFC, 0xFB, 0xF2, 0xF5,
0xD8, 0xDF, 0xD6, 0xD1, 0xC4, 0xC3, 0xCA, 0xCD,
0x90, 0x97, 0x9E, 0x99, 0x8C, 0x8B, 0x82, 0x85,
0xA8, 0xAF, 0xA6, 0xA1, 0xB4, 0xB3, 0xBA, 0xBD,
0xC7, 0xC0, 0xC9, 0xCE, 0xDB, 0xDC, 0xD5, 0xD2,
0xFF, 0xF8, 0xF1, 0xF6, 0xE3, 0xE4, 0xED, 0xEA,
0xB7, 0xB0, 0xB9, 0xBE, 0xAB, 0xAC, 0xA5, 0xA2,
0x8F, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9D, 0x9A,
0x27, 0x20, 0x29, 0x2E, 0x3B, 0x3C, 0x35, 0x32,
0x1F, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0D, 0x0A,
0x57, 0x50, 0x59, 0x5E, 0x4B, 0x4C, 0x45, 0x42,
0x6F, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7D, 0x7A,
0x89, 0x8E, 0x87, 0x80, 0x95, 0x92, 0x9B, 0x9C,
0xB1, 0xB6, 0xBF, 0xB8, 0xAD, 0xAA, 0xA3, 0xA4,
0xF9, 0xFE, 0xF7, 0xF0, 0xE5, 0xE2, 0xEB, 0xEC,
0xC1, 0xC6, 0xCF, 0xC8, 0xDD, 0xDA, 0xD3, 0xD4,
0x69, 0x6E, 0x67, 0x60, 0x75, 0x72, 0x7B, 0x7C,
0x51, 0x56, 0x5F, 0x58, 0x4D, 0x4A, 0x43, 0x44,
0x19, 0x1E, 0x17, 0x10, 0x05, 0x02, 0x0B, 0x0C,
0x21, 0x26, 0x2F, 0x28, 0x3D, 0x3A, 0x33, 0x34,
0x4E, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5C, 0x5B,
0x76, 0x71, 0x78, 0x7F, 0x6A, 0x6D, 0x64, 0x63,
0x3E, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2C, 0x2B,
0x06, 0x01, 0x08, 0x0F, 0x1A, 0x1D, 0x14, 0x13,
0xAE, 0xA9, 0xA0, 0xA7, 0xB2, 0xB5, 0xBC, 0xBB,
0x96, 0x91, 0x98, 0x9F, 0x8A, 0x8D, 0x84, 0x83,
0xDE, 0xD9, 0xD0, 0xD7, 0xC2, 0xC5, 0xCC, 0xCB,
0xE6, 0xE1, 0xE8, 0xEF, 0xFA, 0xFD, 0xF4, 0xF3,
}; //Check =F4 ..ok

static const uint16_t CRC15_Lookup[256] = {
0x0000, 0x8B32, 0x9D56, 0x1664, 0xB19E, 0x3AAC, 0x2CC8, 0xA7FA,
0xE80E, 0x633C, 0x7558, 0xFE6A, 0x5990, 0xD2A2, 0xC4C6, 0x4FF4,
0x5B2E, 0xD01C, 0xC678, 0x4D4A, 0xEAB0, 0x6182, 0x77E6, 0xFCD4,
0xB320, 0x3812, 0x2E76, 0xA544, 0x02BE, 0x898C, 0x9FE8, 0x14DA,
0xB65C, 0x3D6E, 0x2B0A, 0xA038, 0x07C2, 0x8CF0, 0x9A94, 0x11A6,
0x5E52, 0xD560, 0xC304, 0x4836, 0xEFCC, 0x64FE, 0x729A, 0xF9A8,
0xED72, 0x6640, 0x7024, 0xFB16, 0x5CEC, 0xD7DE, 0xC1BA, 0x4A88,
0x057C, 0x8E4E, 0x982A, 0x1318, 0xB4E2, 0x3FD0, 0x29B4, 0xA286,
0xE78A, 0x6CB8, 0x7ADC, 0xF1EE, 0x5614, 0xDD26, 0xCB42, 0x4070,
0x0F84, 0x84B6, 0x92D2, 0x19E0, 0xBE1A, 0x3528, 0x234C, 0xA87E,
0xBCA4, 0x3796, 0x21F2, 0xAAC0, 0x0D3A, 0x8608, 0x906C, 0x1B5E,
0x54AA, 0xDF98, 0xC9FC, 0x42CE, 0xE534, 0x6E06, 0x7862, 0xF350,
0x51D6, 0xDAE4, 0xCC80, 0x47B2, 0xE048, 0x6B7A, 0x7D1E, 0xF62C,
0xB9D8, 0x32EA, 0x248E, 0xAFBC, 0x0846, 0x8374, 0x9510, 0x1E22,
0x0AF8, 0x81CA, 0x97AE, 0x1C9C, 0xBB66, 0x3054, 0x2630, 0xAD02,
0xE2F6, 0x69C4, 0x7FA0, 0xF492, 0x5368, 0xD85A, 0xCE3E, 0x450C,
0x4426, 0xCF14, 0xD970, 0x5242, 0xF5B8, 0x7E8A, 0x68EE, 0xE3DC,
0xAC28, 0x271A, 0x317E, 0xBA4C, 0x1DB6, 0x9684, 0x80E0, 0x0BD2,
0x1F08, 0x943A, 0x825E, 0x096C, 0xAE96, 0x25A4, 0x33C0, 0xB8F2,
0xF706, 0x7C34, 0x6A50, 0xE162, 0x4698, 0xCDAA, 0xDBCE, 0x50FC,
0xF27A, 0x7948, 0x6F2C, 0xE41E, 0x43E4, 0xC8D6, 0xDEB2, 0x5580,
0x1A74, 0x9146, 0x8722, 0x0C10, 0xABEA, 0x20D8, 0x36BC, 0xBD8E,
0xA954, 0x2266, 0x3402, 0xBF30, 0x18CA, 0x93F8, 0x859C, 0x0EAE,
0x415A, 0xCA68, 0xDC0C, 0x573E, 0xF0C4, 0x7BF6, 0x6D92, 0xE6A0,
0xA3AC, 0x289E, 0x3EFA, 0xB5C8, 0x1232, 0x9900, 0x8F64, 0x0456,
0x4BA2, 0xC090, 0xD6F4, 0x5DC6, 0xFA3C, 0x710E, 0x676A, 0xEC58,
0xF882, 0x73B0, 0x65D4, 0xEEE6, 0x491C, 0xC22E, 0xD44A, 0x5F78,
0x108C, 0x9BBE, 0x8DDA, 0x06E8, 0xA112, 0x2A20, 0x3C44, 0xB776,
0x15F0, 0x9EC2, 0x88A6, 0x0394, 0xA46E, 0x2F5C, 0x3938, 0xB20A,
0xFDFE, 0x76CC, 0x60A8, 0xEB9A, 0x4C60, 0xC752, 0xD136, 0x5A04,
0x4EDE, 0xC5EC, 0xD388, 0x58BA, 0xFF40, 0x7472, 0x6216, 0xE924,
0xA6D0, 0x2DE2, 0x3B86, 0xB0B4, 0x174E, 0x9C7C, 0x8A18, 0x012A,
};

uint8_t crc5(uint8_t crc, unsigned char *ptr, unsigned int bits)
{
	crc<<=3; // (0x1F<<3)
	int i;
	for (i=0; i< (bits>>3); i++)
		crc = CRC5_Lookup[crc ^ (*ptr++)];
	bits &= 7;
	if (bits)
	{
		crc = (crc << bits) ^ CRC5_Lookup[(crc ^ (*ptr++))>>(8-bits)];
	}
	return (crc>>3);
}
uint8_t    crc8(uint8_t crc, unsigned char *ptr, size_t len) {
	while(len--){
		crc = CRC8_Lookup[crc^(*ptr++)];
	}
	return crc;
}
uint16_t crc15_can(uint16_t crc, unsigned char *ptr, size_t len)
{
	crc<<=1; // (0x1F<<3)
	while(len--){
		crc^= ((*ptr++)<<8);
		crc = (crc << 8) ^ CRC15_Lookup[crc>>8];
	}
	return (crc>>1);
}

uint16_t crc16_itu(uint16_t crc, const unsigned char *buffer, size_t len)
{
	while(len--)
	{
		crc = crc16_table[((crc >> 8) ^ (*buffer++)) & 0xFF] ^ (crc << 8);
	}
	return crc;
}


#ifdef TEST_CRC5
#include <stdio.h>
#define CRC5_CHECK 0x0F
#define CRC8S_CHECK 0xF4
#define CRC16_CHECK 0x29b1
#define CRC15_CHECK 0x059e
#define CRC15_XOUT 0x059e
#define CRC16X_CHECK 0x31c3
#define crc16(buffer,len) crc16_itu(0, buffer, len)
int main()
{
	uint8_t test[12] = "123456789";
	uint16_t crc = crc16_itu(0xFFFF, test, 9);
	uint16_t c16 = crc16_itu(0,test, 9);
	uint16_t c15 = crc15_can(0,test, 9);
	uint8_t  c8 = crc8(0, test, 9);
	uint8_t  c5 = crc5(0x1F, test, 9*8);
	printf("CRC-16/CCITT-FALSE check=0x%04X ..%s\n", crc, CRC16_CHECK==crc?"ok":"fail");
	printf("CRC-16 check=0x%04X ..%s\n", c16, CRC16X_CHECK==c16?"ok":"fail");
	printf("CRC-15/CAN check=0x%04X ..%s\n", c15, CRC15_CHECK==(c15)?"ok":"fail");
	printf("CRC-8/SMBUS check=0x%02X ..%s\n", c8, CRC8S_CHECK==c8?"ok":"fail");
	printf("CRC-5/BITMAIN check=0x%02X ..%s\n", c5, CRC5_CHECK==c5?"ok":"fail");
	int i;
	for (i=0; i<8; i++){
		test[9] = i<<5;
		uint8_t  c8 = crc5(0x1F, test, 10*8-5);
		test[9] = (i<<5)|c8;
		uint8_t  c5 = crc5(0x1F, test, 10*8);
		printf("crc5 magic = 0x%02X\n", c5);
		
	}
	for (i=0; i<1; i++){
		test[9] = 0;
		uint8_t  c8 = crc8(0, test, 9);
		test[9] = c8;
		uint8_t  c5 = crc8(0, test, 10);
		printf("crc8 magic = 0x%02X\n", c5);
	}

	return 0;
}
#endif